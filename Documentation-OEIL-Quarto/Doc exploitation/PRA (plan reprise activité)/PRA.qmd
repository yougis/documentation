# PRA - Plan de reprise d'activité

L’objectif de ce document est d’établir un plan d’actions à mettre en place afin d’éviter toute perte de données et d’applications. A partir du plan de rétablissement, l’OEIL doit être en mesure de remonter toutes ces applications et de récupérer toutes ces données en cas d’incident sur notre infrastructure locale. 

## Infrastructure actuelle (2024)

[Liste des serveurs portant des applications ou des services pour le fonctionnement des activités de l'OEIL](<../../Infrastructure/Organisation infrastructure hybrid.md>)


```{mermaid}
%%|label: fig-infra-locale

graph TB
  root((Locale))
  root --> Firewall
  root --> Isengard
  root --> Mordor
  root --> HyperV_Windows_2016[(HyperV - Windows 2016)]
  root --> NAS_Moria[(NAS Moria)]
  root --> NAS_QNAP_Rivendell[(NAS QNAP Rivendell)]

  classDef icon_server fill:#ccf,stroke:#333,stroke-width:4px;
  classDef icon_warehouse fill:#cff,stroke:#333,stroke-width:4px;


```


```{mermaid}
%%|label: fig-isengard

graph TB
  Isengard((Isengard))
  Isengard --> Portainer_Agent1[Portainer Agent]
  Portainer_Agent1:::icon_cube
  Isengard --> Postgres1[Postgres]
  Postgres1:::icon_database
  Isengard --> GDAL[GDAL]
  GDAL:::icon_cogs
  Isengard --> JupyterHub[JupyterHub]
  JupyterHub:::icon_cogs
  Isengard --> Dashboards_Sentinel2[Dashboards Sentinel 2]
  Dashboards_Sentinel2:::icon_cogs
  Isengard --> Dask_worker1[Dask worker]
  Dask_worker1:::icon_cogs
  Isengard --> Scheduler_Dask1[Scheduler Dask]
  Scheduler_Dask1:::icon_cogs

  classDef icon_cube fill:#f9f,stroke:#333,stroke-width:4px;
  classDef icon_database fill:#bbf,stroke:#333,stroke-width:4px;
  classDef icon_cogs fill:#fcf,stroke:#333,stroke-width:4px;


```

```{mermaid}
%%|label: fig-Mordor
graph TB
  Mordor((Mordor))
  Mordor --> Portainer_Agent2[Portainer Agent]
  Portainer_Agent2:::icon_cube
  Mordor --> Azure_Pipeline_Agent[Azure Pipeline Agent]
  Azure_Pipeline_Agent:::icon_cogs
  Mordor --> Postgres2[Postgres]
  Postgres2:::icon_database
  Mordor --> Geoserveur[Geoserveur]
  Geoserveur:::icon_cogs
  Mordor --> Ckan[Ckan]
  Ckan:::icon_cogs
  Mordor --> Dask_worker2[Dask worker]
  Dask_worker2:::icon_cogs
  Mordor --> Scheduler_Dask2[Scheduler Dask]
  Scheduler_Dask2:::icon_cogs

  classDef icon_cube fill:#f9f,stroke:#333,stroke-width:4px;
  classDef icon_database fill:#bbf,stroke:#333,stroke-width:4px;
  classDef icon_cogs fill:#fcf,stroke:#333,stroke-width:4px;

```

```{mermaid}
%%|label: fig-HyperV

graph TB
  HyperV_Windows_2016[(HyperV - Windows 2016)]
  HyperV_Windows_2016 --> VM_AD_Windows_2016[VM AD - Windows 2016]
  VM_AD_Windows_2016:::icon_desktop
  HyperV_Windows_2016 --> VM_INFRA_Windows_2016[VM INFRA - Windows 2016]
  VM_INFRA_Windows_2016:::icon_desktop

  classDef icon_desktop fill:#ccf,stroke:#333,stroke-width:4px;
```

```{mermaid}
%%|label: fig-NAS_Moria

graph TB
  NAS_Moria[(NAS Moria)]
  NAS_Moria --> Commun[Commun]
  Commun:::icon_folder
  NAS_Moria --> Archive[Archive]
  Archive:::icon_folder
  NAS_Moria --> Tampon[Tampon]
  Tampon:::icon_folder
  NAS_Moria --> CalPaye[CalPaye]
  CalPaye:::icon_app
  NAS_Moria --> Syncovery[Syncovery]
  Syncovery:::icon_app
  NAS_Moria --> Novatech[Novatech]
  Novatech:::icon_app

  classDef icon_folder fill:#cff,stroke:#333,stroke-width:4px;
  classDef icon_app fill:#ffc,stroke:#333,stroke-width:4px;
```


```{mermaid} 
%%|label: fig-NAS_QNAP_Rivendell
graph TB
  NAS_QNAP_Rivendell[(NAS QNAP Rivendell)]
  NAS_QNAP_Rivendell:::icon_warehouse

  classDef icon_warehouse fill:#cff,stroke:#333,stroke-width:4px;
```


```{mermaid}
%%|label: fig-Insight
graph TB
  root((Insight))
  root --> Serveur_traitement((Serveur traitement))
  Serveur_traitement --> Chaine_traitement_incendie[Chaine de traitement incendie]
  Chaine_traitement_incendie:::icon_fire
  Serveur_traitement --> Chaines_traitement_secheresse[Chaines de traitement sécheresse dockerisées]
  Chaines_traitement_secheresse  -->  Chaines_VHI[Chaines de traitement VHI]

  Chaines_traitement_secheresse  -->  Chaines_VAI[Chaines de traitement VAI]
  Chaines_traitement_secheresse  -->  Chaines_Prevision[Chaines de traitement Prévision]
  Chaines_Prevision:::icon_not_in_production
  Chaines_traitement_secheresse  -->  Chaines_Alerte[Chaines de traitement Alerte]
  Chaines_traitement_secheresse:::icon_tint
  root --> NAS_geostorage((NAS geostorage))
  NAS_geostorage:::icon_warehouse

  classDef icon_server fill:#ccf,stroke:#333,stroke-width:4px;
  classDef icon_fire fill:#f66,stroke:#333,stroke-width:4px;
  classDef icon_not_in_production fill:#fff,stroke:#333,stroke-width:4px;
  classDef icon_tint fill:#66f,stroke:#333,stroke-width:4px;
  classDef icon_warehouse fill:#cff,stroke:#333,stroke-width:4px;

      
```

```{mermaid}
%%|label: fig-Cloud
graph TB
  root((Cloud))
  root:::icon_cloud
  
  root --> Geoportail((Geoportail))
  Geoportail:::icon_server
  Geoportail --> Arcgis_Server[Arcgis Server]
  Arcgis_Server:::icon_cogs
  Geoportail --> SQL_Server[SQL Server]
  SQL_Server:::icon_database
  Geoportail --> FME_script_ETL_alerte_Incendie[FME et script ETL alerte Incendie]
  FME_script_ETL_alerte_Incendie:::icon_code
  FME_script_ETL_alerte_Incendie --> Notifications[Notifications]
  Notifications:::icon_mail_bulk
  Geoportail --> Vulcain_Pro[Vulcain Pro]
  Vulcain_Pro:::icon_cogs
  Geoportail --> Applications_Topomat[Applications Topomat]
  Applications_Topomat:::icon_cogs

  root --> Serveur_Site_Web((Serveur Site Web))
  Serveur_Site_Web:::icon_server
  Serveur_Site_Web --> CMS_Drupal[CMS Drupal]
  CMS_Drupal:::icon_cogs
  Serveur_Site_Web --> Application_CDRN[Application CDRN]
  Application_CDRN:::icon_cogs
  Serveur_Site_Web --> Base_de_données_MySQL[Base de données MySQL]
  Base_de_données_MySQL:::icon_database

  root --> Serveur_Hydrobio((Serveur Hydrobio))
  Serveur_Hydrobio:::icon_server
  Serveur_Hydrobio --> Application_NET[Application .NET]
  Application_NET:::icon_cogs
  Serveur_Hydrobio --> Base_de_données_MySQL_Hydro[Base de données MySQL]
  Base_de_données_MySQL_Hydro:::icon_database

  root --> Serveur_Barman_aws((Serveur Barman-aws))
  Serveur_Barman_aws:::icon_server
  Serveur_Barman_aws --> Barman[Barman]
  Barman:::icon_cogs
  Serveur_Barman_aws --> RDS_remote_database_service[RDS remote database service]
  RDS_remote_database_service:::icon_database

  classDef icon_cloud fill:#ccf,stroke:#333,stroke-width:4px;
  classDef icon_server fill:#f96,stroke:#333,stroke-width:4px;
  classDef icon_cogs fill:#fcf,stroke:#333,stroke-width:4px;
  classDef icon_database fill:#bbf,stroke:#333,stroke-width:4px;
  classDef icon_code fill:#cff,stroke:#333,stroke-width:4px;
  classDef icon_mail_bulk fill:#ffc,stroke:#333,stroke-width:4px;

```



## Systèmes de backups existants

- Local Common : le stockage RAID 5 supporte la perte d'un ou 2 disques, les données sont en plus backupés par Novatech vers le serveur 1 fois / jour. A terme, une synchronisation temps réelle avec Sharepoint est envisagée.
- Local Archive : le stockage RAID 5 supporte la perte d'un ou 2 disques, mais les données ne sont pas backupées car elles sont considérées comme des archives mais on pourrait envisager de les sauvegarder sur un autre support certaines données.
- Local Isengard: le stockage RAID 5 supporte la perte d'un ou 2 disques, de plus la base de données est backupée par un dumpALL 1 fois / jour et un système de copie par WALL (Barman) permet une réplication sur le cloud en temps quasi réel avec une resilience des données sur 1 mois environs.
- Windows Server 2016 HyperV : pas de backup en place actuellement mais il est prévu de sauvegarder les données sur en NAS en local (QNAP) puis dans le Cloud
- Cloud Serveur Hydrobio  : système de snapshot régulier mis en place mais pas d’accès au code ni aux données de la base
- Serveur Insight : les fichiers générés sont régulièrement sauvegardés localement grace un rsync vers le dossier Archive et la base de données.
- Cloud Serveur Site Web : un système de snapshot du serveur est effectué 1 fois / jour
- Serveur Windows Geoportail : le serveur complet est également backupé par snapshot 1 fois / jour avec un historique de 2 semaines
- Serveur RDS (Remote Database Service) : idem, la base de données est sauvegardée par snapshot 1 fois / jour avec un historique de 1 semaine
- SAAS : les données mail, OneDrive et Sharepoint sont backupées via le Cloudally.

Mise à part le serveur Mordor (non sensible), l’ensemble de notre infrastructure est donc backupée. Mordor est un serveur de qualification, il n’est donc pas nécessaire de le sauvegarder, il pourra toutefois porter une instance de Barman pour assurer une réplication et des restaurations de la base de donnée de production très rapidement contrairement à plusieurs heures aujourd'hui.

Les contrats de maintenance signés avec les prestataires : 



## Backuper les applications et leurs données

Pour chaque application développée par nous même ou des prestataires, nous devons nous assurer que le code source a bien été enregistré et versionné dans une forge Git. Azure DevOps a été choisi car il est sous la coupe de Microsoft et de fait plus intégré à O365 (gestion des utilisateurs simplifié). Idéalement, chaque application doit également contenir un Dockerfile permet de l’exécuter sur n’importe quel système et environnement. Il est important pour chaque projet de documenter la commande docker à utiliser pour exécuter l’application (paramètres spécifiques, variables d’environnements, etc.). Il sera même préférable d’avoir un fichier docker-compose.yml par projet, afin de faciliter le paramétrage et le déploiement de l’application. Chaque application en production doit être versionnée (ex : v1.0.0 utilisant le système standard de versioning).

Pour les applications que nous utilisons localement pour nos traitements et l'administration des données, [un repo Git "Backup"](https://dev.azure.com/Oeilnc/Backup) a été mis en place. Ce repo permet notamment de redéployer les applications des différent serveur Mordor/Isengar/... et également celles des machines des utilisateurs à l’aide de Docker Compose. Le README contient toutes les informations et les étapes nécessaires au redéploiement ou à la mise à jour de ces applications.

## Plan de rétablissement des données et applications en cas d’incident

En cas de perte partielle ou totale de nos données et applications, il suffit de suivre les étapes suivantes afin de remonter notre infrastructure applicative et nos données. Cette perte peut être due à un incident technique (panne de disque, incendie, inondation, etc.), à une attaque informatique (virus, ransomware, etc.) ou à une erreur humaine (suppression de données, mauvaise manipulation, etc.). Toutefois un diagnostic de l'incident doit être réalisé pour déterminer la cause de l'incident et évaluer si une remontée en l'état est possible. Dans le cas ou un problème de lecture disque du serveur est identifié, une restauration du RAID (déconnection du disque et reconnexion) peut parfois restaurer l'état de fonctionnement normal. il est aussi possible de faire appel à un prestataire spécialisé pour s'assurer que la récupération des données n'est pas possible facilement.

### Remonter les serveurs locaux

Le projet Backup sur Azure Devops détaille comment restaurer les applications et leurs données sur le serveur Mordor. 

### Remonter le commun et les données historiques (local)

Après avoir verifié l'état du NAS, de ses disques et diagnostiqué que seule une restauration complète est envisageable, les volumes du NAS doivent etre redefini.


Le serveur Local Common est backupé par Novatech. Se rapprocher du prestataire Novatech pour récupérer l’ensemble des fichiers sauvegardés.il suffit de suivre la procédure de restauration pour remonter les données.




### Remonter le serveur Windows 2016 HyperV (local)

Pour l’instant il n’y a pas de backup pour cette machine, il n’y a donc pas de procédure de remise en service à suivre en cas d’incident.

### Remonter le serveur Multivalency (Cloud)

Se rapprocher du prestataire Multivalency pour remonter le serveur avec un snapshots récent.

### Remonter le serveur InSight (Cloud)

Seuls les fichiers générés par la chaîne de traitement sont sauvegardés, on ne pourra donc pas remonter la chaîne en cas de crash. A voir avec Insight ce qu’il est possible de faire. Cette chaîne est vouée à évoluer, en utilisant notamment d’autres technologies.

### Remonter le serveur Alphalog (Cloud)

Se rapprocher du prestataire Alphalog pour remonter le serveur avec un snapshots récent.

### Remonter le Geoportail (Cloud)

Via l’interface de gestion du serveur dans AWS, il est possible de restaurer le serveur à partir d’un snapshot récent.

### Remonter la base Amazon RDS (Cloud)

Via l’interface de gestion du serveur dans AWS, il est possible de restaurer le serveur à partir d’un snapshot récent.

### Remonter les applications SaaS

Se rapprocher du prestataire Novatech qui assure le backup Cloudally pour la sauvegarde des données SaaS.